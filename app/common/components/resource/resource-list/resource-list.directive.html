<!-- Listing -->
<div class="row">
  <div class="current-lot fill-height-bar col-lg-6">
    <resource-breadcrumb></resource-breadcrumb>
    <!-- Resource Filters -->
    <resource-search settings="config.search.params"
                     on-params-changed="onSearchParamsChanged(params)"
                     default-params="config.search.defaultParams"
    ></resource-search>
    <h4>Lots ({{ getTotalNumberOfLots() }})</h4>
    <div class="children-lots"
    >
      <ul>
        <li
                ng-repeat="lot in getLots()"
        >
          <a href="#" ng-click="openFull(lot)">
            <i class="fa fa-fw fa-lg fa-folder-o "></i>{{ lot.label }}
          </a>
        </li>
        <li ng-show="morePagesAvailableLots">
          <a href="#" ng-click="getMoreLots()">
            Show more
          </a>
        </li>
      </ul>
    </div>

    <h4 style="display: inline-block; margin-bottom: 20px;">Devices ({{ getTotalNumberOfDevices() }}) </h4>
    <button type="button"
            class="btn"
            style="display: inline-block; padding: 5px 10px; margin-left: 10px;"
            ng-class="{'btn-info': getDevices().length > 0}"
            ng-show="!areAllDevicesOfCurrentLotSelected"
            ng-click="selector.selectAll(getDevices(), parentResource)"
    >
      <span>Select all</span>
    </button>
    <button type="button"
            class="btn"
            style="display: inline-block; padding: 5px 10px; margin-left: 10px;"
            ng-class="{'btn-info': getDevices().length > 0}"
            ng-show="areAllDevicesOfCurrentLotSelected"
            ng-click="deselectAll(getDevices())"
    >
      <span>Deselect all</span>
    </button>

    <div infinite-scroll="getMore()" infinite-scroll-distance='0.8' infinite-scroll-use-document-bottom="false"
         infinite-scroll-parent infinite-scroll-disabled="getMoreIsBusy || !morePagesAvailable"
         infinite-scroll-listen-for-event="list:filtered"
    >
      <table id="resource-list-table" class="table table-striped table-hover">
        <thead>
          <tr>
            <th ng-repeat="th in config.table.th"
                field-sort sort="setSort(sort)" key="{{::th.key}}" name="{{::th.name}}" group="sort"
                sort-by-default="th.default"
            ></th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          <tr ng-repeat="resource in devices track by resource._id"
              ng-class="{info: selector.isSelected(resource)}"

              ng-init="popover = popovers[resource._id]"

              uib-popover-template="::popovers.templateUrl"
              popover-enable="popovers.enable"
              popover-title="{{::popover.title}}"
              popover-is-open="popover.isOpen"
              popover-trigger="click"
              popover-append-to-body="true"
              popover-placement="{{popoverPlacement}}"
              popover-class="resource-button-popover"

              ng-click="toggleSelect(resource, $index, $event)"
          >
            <!-- $evalasync from https://stackoverflow.com/a/31352712 -->
            <td ng-repeat="td in ::config.table.td"
                ng-init="value = $root._.get(resource, td.value)"
            >
              <div ng-if="::td.templateUrl" ng-include="td.templateUrl"></div>
              <div ng-if="::value && !$root._.isDate(value)">
                <!-- We cannot use the value from ng-init if we want it to be updateable -->
                <span ng-if="::td.humanize">
                  {{::$root._.get(resource, td.value) | humanize}}
                </span>
                <span ng-if="::td.number">
                  {{::$root._.get(resource, td.value) | number}}
                </span>
                <!-- For now only label can be changed from a resource without refreshing the list, and label field
                falls in here -->
                <span ng-if="::!td.humanize && !td.number">
                  <!-- Let's show more characters if we have a lg screen -->
                  <span class="hidden-lg">
                    {{$root._.get(resource, td.value) | limitTo: (td.limitTo || 15)}}
                    <small ng-show="$root._.get(resource, td.value).length > (td.limitTo || 15)">&hellip;</small>
                  </span>
                  <span class="hidden-xs hidden-sm hidden-md">
                    {{$root._.get(resource, td.value) | limitTo: (td.limitTo || 15) + 7}}
                    <small ng-show="$root._.get(resource, td.value).length > (td.limitTo || 15) + 7">&hellip;</small>
                  </span>
                </span>
              </div>
              <div ng-if="::value && $root._.isDate(value)">{{value | timeAgo}}</div>
            </td>
          </tr>
        </tbody>
      </table>
      <div class="text-center">
        <i
          ng-class="{
                      'fa fa-circle-o-notch fa-spin fa-lg': getMoreIsBusy && morePagesAvailable,
                      'fa fa-ellipsis-h fa-lg': !morePagesAvailable
                    }
                   "
        ></i>
      </div>
    </div>
  </div>
  <!-- Selection -->
  <aside class="selection col-lg-6 fill-height-bar">
    <div ng-if="allSelectedDevices.length === 0">
      <h3>Select devices to view more details</h3>
    </div>

    <div ng-if="allSelectedDevices.length > 0">
      <h4>Current selection</h4>
      <h3>{{allSelectedDevices.length}} devices in {{selectedLots.length}} lots</h3>
      <ul>
        <li
          ng-repeat="lot in selectedLots | limitTo: numSelectedLotsShown track by lot._id"
          class="pill-lot pill-lot-flex"
          ng-click="showLot(lot)"
        >

          <div>
            <i class="fa fa-fw fa-lg fa-folder-o "></i><span ng-show="lot.current">Current: </span>{{ lot.label }} ({{ lot.selectedDevices.length }})
          </div>
          <button type="button"
                  class="btn"
                  ng-click="deselectAll(lot.selectedDevices)"
          >
            <span><i class="fa fa-close fa-fw"></i></span>
          </button>
        </li>
        <li
          ng-show="showDisplayMoreSelectedLotsButton"
          class="pill-lot pill-lot-flex"
        >
          <button type="button"
                  class="btn"
                  ng-click="showMoreSelectedLots()"
          >
            <span>Show more</span>
          </button>
        </li>
      </ul>
      <div style="position: relative; overflow-x: hidden;">
        <ul class="selection-summary">
          <li ng-repeat="row in selectionSummary track by row.title">
            <button type="button"
                    class="btn"
                    ng-click="selectionDetails[row.title] = true"
            >
              <span class="selection-summary-title">{{row.title}}</span>
              <span class="selection-summary-content">{{row.contentSummary}}</span>
              <i class="fa fa-chevron-right fa-fw"></i>
            </button>
          </li>
        </ul>
        <div ng-repeat="row in selectionSummary track by row.title"
             class="selection-details-panel"
             ng-class="{ active: selectionDetails[row.title] }"
        >
          <div class="selection-details-content-wrapper">
            <div class="selection-details-content-container">
              <div ng-if="::row.templateUrl"
                   ng-include="::row.templateUrl"
                   ng-class="row.cssClass"
                   style="position: relative">
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Buttons -->
      <div id="buttons" class="row">
        <resource-label-button></resource-label-button>
        <manual-events-button></manual-events-button>
        <!--&lt;!&ndash;<share devices="selector.getAllSelectedDevices()"></share>&ndash;&gt;-->
        <certificate-button></certificate-button>
        <group-resource-button success="reload()" resource-type="Device"></group-resource-button>
        <resource-export resources="selector.getAllSelectedDevices()"></resource-export>
      </div>
    </div> <!-- ./ selectDevices > 0 -->

  </aside>
</div>

