<h2>Resource list</h2>

<!-- Resource Filters -->
<div class="row">
  <resource-search class="col-md-10 col-xs-offset-0 col-md-offset-1 show subview-12 subview-offset-0"
                   settings="config.search.params"
                   on-params-changed="onSearchParamsChanged(params)"
                   default-params="config.search.defaultParams"
  ></resource-search>
</div>

<div class="row">
  <span>Selected {{selector.total.length}} in total, {{selector.inList.length}} in this list</span>
  <button type="button"
          class="btn"
          ng-class="{'btn-primary': resources.length > 0}"
          ng-show="selector.inList.length != resources.length"
          ng-click="selector.toggleSelectAll(true)"
  >
    <span><i class="fa fa-select fa-fw"></i>Select all</span>
  </button>
  <button type="button"
          class="btn"
          ng-class="{'btn-primary': resources.length > 0}"
          ng-show="selector.inList.length == resources.length"
          ng-click="selector.toggleSelectAll(false)"
  >
    <span><i class="fa fa-select fa-fw"></i>Deselect all</span>
  </button>
</div>

<!-- Listing -->
<div class="row">
  <div
    ng-class="'col-xs-2 col-sm-4 col-lg-5'"
    class="fill-height-bar"
  >
    <div infinite-scroll="getMore()" infinite-scroll-distance='0.8' infinite-scroll-use-document-bottom="false"
         infinite-scroll-parent infinite-scroll-disabled="getMoreIsBusy || !morePagesAvailable"
         infinite-scroll-listen-for-event="list:filtered"
    >
      <table id="resource-list-table" class="table table-striped table-hover">
        <thead>
          <tr>
            <th ng-repeat="th in config.table.th"
                field-sort sort="setSort(sort)" key="{{::th.key}}" name="{{::th.name}}" group="sort"
                sort-by-default="th.default"
            ></th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          <tr ng-repeat="resource in resources track by resource._id"
              ng-class="{info: selector.isInList(resource)}"

              ng-init="popover = popovers[resource._id]"

              uib-popover-template="::popovers.templateUrl"
              popover-enable="popovers.enable"
              popover-title="{{::popover.title}}"
              popover-is-open="popover.isOpen"
              popover-trigger="click"
              popover-append-to-body="true"
              popover-placement="{{popoverPlacement}}"
              popover-class="resource-button-popover"

              ng-click="$evalAsync(toggleSelect(resource, $event, $index))"
              ng-dblclick="openFull(resource)"
          >

          <!--<td ng-class="{'hidden-xs': subResource.resource}">
            <input class="resource-list-checkbox"
                   type="checkbox"
                   ng-click=""
                   ng-model="selector.checkboxes[resource['_id']]"
                   ng-class="{blink: hoverScreener && resource._id === resources[0]._id && inList.length == 0}"
            >
          </td>-->
            <!-- $evalasync from https://stackoverflow.com/a/31352712 -->
            <td ng-repeat="td in ::config.table.td"
                ng-init="value = $root._.get(resource, td.value)"
            >
              <div ng-if="::td.templateUrl" ng-include="td.templateUrl"></div>
              <div ng-if="::value && !$root._.isDate(value)">
                <!-- We cannot use the value from ng-init if we want it to be updateable -->
                <span ng-if="::td.humanize">
                  {{::$root._.get(resource, td.value) | humanize}}
                </span>
                <span ng-if="::td.number">
                  {{::$root._.get(resource, td.value) | number}}
                </span>
                <!-- For now only label can be changed from a resource without refreshing the list, and label field
                falls in here -->
                <span ng-if="::!td.humanize && !td.number">
                  <!-- Let's show more characters if we have a lg screen -->
                  <span class="hidden-lg">
                    {{$root._.get(resource, td.value) | limitTo: (td.limitTo || 15)}}
                    <small ng-show="$root._.get(resource, td.value).length > (td.limitTo || 15)">&hellip;</small>
                  </span>
                  <span class="hidden-xs hidden-sm hidden-md">
                    {{$root._.get(resource, td.value) | limitTo: (td.limitTo || 15) + 7}}
                    <small ng-show="$root._.get(resource, td.value).length > (td.limitTo || 15) + 7">&hellip;</small>
                  </span>
                </span>
              </div>
              <div ng-if="::value && $root._.isDate(value)">{{value | timeAgo}}</div>
            </td>
          </tr>
        </tbody>
      </table>
      <div class="text-center">
        <i
          ng-class="{
                      'fa fa-circle-o-notch fa-spin fa-lg': getMoreIsBusy && morePagesAvailable,
                      'fa fa-ellipsis-h fa-lg': !morePagesAvailable
                    }
                   "
        ></i>
      </div>
    </div>
  </div>
  <!-- SubResource in right-bar -->
  <aside class="col-xs-10 col-sm-8 col-lg-7" id="aside-subResource">
    <div ng-if="selector.total.length == 0">
      <h4>Summary</h4>
      <h3>{{ parentResource.summary.totalNumberDevices }} devices in lot</h3>
      <ul>
        <li>Device: {{parentResource.summary.deviceType}}</li>
        <li>Status: {{parentResource.summary.status}}</li>
        <li>Price: {{parentResource.summary.price}}, Range: {{parentResource.summary.range}}</li>
        <li>Components: {{parentResource.summary.components}}</li>
        <li>Donors: {{parentResource.summary.donors.join(',')}}, Owner: {{parentResource.summary.owner}}, Distributor:{{parentResource.summary.distributor}}</li>
        <li>Possessor: {{parentResource.summary.possessor}}, Location: {{parentResource.summary.location}}</li>
        <li>Events: {{parentResource.summary.events.join('')}}</li>
      </ul>
    </div>

    <div ng-if="selector.total.length > 0">
      <h4>Current selection</h4>
      <!--<ul> TODO group selected items by lot
        <li
          ng-repeat="lot in ::selector.selectedLots"
          >
          {{ lot.label }} ({{ lot.selectedDevices.length }})
        </li>
      </ul>-->
      <!--<ul> TODO summary for all selected devices (total)
        <li>Device: {{selector.total.summary.deviceType}}</li>
        <li>Status: {{selector.total.summary.status}}</li>
        <li>Price: {{selector.total.summary.price}}, Range: {{selector.total.summary.range}}</li>
        <li>Components: {{selector.total.summary.components}}</li>
        <li>Donors: {{selector.total.summary.donors.join(',')}}, Owner: {{selector.total.summary.owner}}, Distributor:{{selector.total.summary.distributor}}</li>
        <li>Possessor: {{selector.total.summary.possessor}}, Location: {{selector.total.summary.location}}</li>
        <li>Events: {{selector.total.summary.events.join('')}}</li>
      </ul>-->
    </div>

    <!-- Buttons -->
    <div id="buttons" class="row text-center">
      <resource-label-button resources="selector.total"></resource-label-button>
      <manual-events-button resources="selector.total"></manual-events-button>
      <!--<share devices="selector.total"></share>-->
      <certificate-button resources="selector.total"></certificate-button>
      <group-resource-button resources="selector.total"
                             resource-type="{{resourceType}}"
                             success="reload()"
      ></group-resource-button>
      <resource-export resources="selector.total"></resource-export>
    </div>
  </aside>
</div>

