<!-- Listing -->
<div class="row">
  <div class="current-lot fill-height-bar col-sm-6 col-xs-12">
    <resource-breadcrumb></resource-breadcrumb>
    <h4>Lots ({{ totalNumberOfLots }})</h4>
    <div class="children-lots"
    >
      <ul>
        <li
                ng-repeat="lot in lots"
        >
          <button ng-click="goTo(lot)">
            <i class="fa fa-fw fa-lg fa-folder-o "></i>{{ lot.label }}
          </button>
        </li>
        <li ng-show="moreLotsAvailable">
          <a href="#" ng-click="getMoreLots()">
            Show more
          </a>
        </li>
      </ul>
    </div>

    <h4 style="display: inline-block; margin-bottom: 20px;">Devices ({{ totalNumberOfDevices }}) </h4>
    <button type="button"
            class="btn btn-info"
            style="display: inline-block; padding: 5px 10px; margin-left: 10px;"
            ng-show="!selection.areAllDevicesOfCurrentLotSelected && (devices.length > 0)"
            ng-click="selector.selectAll(devices, parentResource)"
    >
      <span>Select all</span>
    </button>
    <button type="button"
            class="btn btn-info"
            style="display: inline-block; padding: 5px 10px; margin-left: 10px;"
            ng-show="selection.areAllDevicesOfCurrentLotSelected && (devices.length > 0)"
            ng-click="deselectAll(devices)"
    >
      <span>Deselect all</span>
    </button>
    <!-- Resource Filters -->
    <resource-search settings="config.search.params"
                     on-params-changed="onSearchParamsChanged(params)"
                     default-params="config.search.defaultParams"
    ></resource-search>

    <div infinite-scroll="getMore()" infinite-scroll-distance='0.8' infinite-scroll-use-document-bottom="false"
         infinite-scroll-parent infinite-scroll-disabled="getMoreIsBusy || !moreDevicesAvailable"
         infinite-scroll-listen-for-event="list:filtered"
    >
      <table id="resource-list-table" class="resource-list-table table table-striped table-hover">
        <thead>
          <tr>
            <th ng-repeat="th in config.table.th"
                class="{{::th.cssClasses}}"
                field-sort sort="setSort(sort)" key="{{::th.key}}" name="{{::th.name}}" group="sort"
                sort-by-default="th.default"
            ></th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          <tr ng-repeat="resource in devices track by resource._id"
              ng-class="{info: selector.isSelected(resource)}"
              ng-click="toggleSelect(resource, $index, $event)"
          >
            <!-- $evalasync from https://stackoverflow.com/a/31352712 -->
            <td ng-repeat="td in ::config.table.td"
                class="{{::td.cssClasses}}"
                ng-init="value = $root._.get(resource, td.value)"
            >
              <div ng-if="::td.templateUrl" ng-include="td.templateUrl"></div>
              <div ng-if="::value && !$root._.isDate(value)">
                <!-- We cannot use the value from ng-init if we want it to be updateable -->
                <span ng-if="::td.humanize">
                  {{::$root._.get(resource, td.value) | humanize}}
                </span>
                <span ng-if="::td.number">
                  {{::$root._.get(resource, td.value) | number}}
                </span>
                <!-- For now only label can be changed from a resource without refreshing the list, and label field
                falls in here -->
                <span ng-if="::!td.humanize && !td.number">
                  <!-- Let's show more characters if we have a lg screen -->
                  <span class="hidden-lg">
                    {{$root._.get(resource, td.value) | limitTo: (td.limitTo || 15)}}
                    <small ng-show="$root._.get(resource, td.value).length > (td.limitTo || 15)">&hellip;</small>
                  </span>
                  <span class="hidden-xs hidden-sm hidden-md">
                    {{$root._.get(resource, td.value) | limitTo: (td.limitTo || 15) + 7}}
                    <small ng-show="$root._.get(resource, td.value).length > (td.limitTo || 15) + 7">&hellip;</small>
                  </span>
                </span>
              </div>
              <div ng-if="::value && $root._.isDate(value)">{{value | timeAgo}}</div>
            </td>
          </tr>
        </tbody>
      </table>
      <div class="text-center">
        <i
          ng-class="{
                      'fa fa-circle-o-notch fa-spin fa-lg': getMoreIsBusy && moreDevicesAvailable,
                      'fa fa-ellipsis-h fa-lg': !moreDevicesAvailable
                    }
                   "
        ></i>
      </div>
    </div>
  </div>
  <!-- Selection button-->
  <div class="selection-button"
       ng-click="selectionPanelHiddenXS = !selectionPanelHiddenXS"
       ng-class="{ 'hidden': selection.devices.length === 0, 'visible-xs-block': selection.devices.length > 0 }">
    <button ng-show="selectionPanelHiddenXS" class="btn-info btn-view-selected">View selected devices ({{selection.devices.length}})</button>
    <button ng-show="!selectionPanelHiddenXS" class="btn-info btn-view-list">View device list</button>
  </div>
  <!-- Selection -->
  <aside class="selection col-sm-6 fill-height-bar col-xs-12"
         ng-class="{ 'hidden-xs': selectionPanelHiddenXS }">
    <div ng-if="selection.devices.length === 0">
      <h3>Select devices to view more details</h3>
    </div>

    <div ng-if="selection.devices.length > 0">
      <h4>Current selection</h4>
      <h3>{{selection.devices.length}} devices</h3>
      <ul>
        <li
          ng-repeat="device in selection.devices | limitTo: selection.numSelectedLotsShown track by device._id"
          class="pill-device pill-device-flex"
        >
          <div>
            <i class="fa fa-fw fa-lg fa-desktop"></i>{{ device.title }}
          </div>
        </li>
        <li
          ng-show="selection.showDisplayMoreSelectedLotsButton"
          class="pill-lot pill-lot-flex"
        >
          <button type="button"
                  class="btn"
                  ng-click="selection.showMoreSelectedLots()"
          >
            <span>Show more</span>
          </button>
        </li>
      </ul>
      <div style="position: relative; overflow-x: hidden;">
        <ul class="selection-summary">
          <li ng-repeat="row in selection.summary track by row.title">
            <button type="button"
                    class="btn"
                    ng-click="selection.details[row.title] = true"
            >
              <span class="selection-summary-title">{{row.title}}</span>
              <span class="selection-summary-content">{{row.contentSummary}}</span>
              <i class="fa fa-chevron-right fa-fw"></i>
            </button>
          </li>
        </ul>
        <div ng-repeat="row in selection.summary track by row.title"
             class="selection-details-panel"
             ng-class="{ active: selection.details[row.title] }"
        >
          <div class="selection-details-content-wrapper">
            <div class="selection-details-content-container">
              <div ng-if="::row.templateUrl"
                   ng-include="::row.templateUrl"
                   ng-class="row.cssClass"
                   style="position: relative">
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Buttons -->
      <div id="buttons" class="row">
        <resource-label-button></resource-label-button>
        <manual-events-button></manual-events-button>
        <!--&lt;!&ndash;<share devices="selector.getAllSelectedDevices()"></share>&ndash;&gt;-->
        <certificate-button></certificate-button>
        <group-resource-button
                success="reload()"
                resource-type="Device"
                get-resources="selector.getAllSelectedDevices()"
                register-to-resources-update="selector.callbackOnSelection(callback)">
        </group-resource-button>
        <resource-export resources="selector.getAllSelectedDevices()"></resource-export>
      </div>
    </div> <!-- ./ selectDevices > 0 -->

  </aside>
</div>

